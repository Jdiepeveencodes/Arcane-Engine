<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D 5e Character Sheet - Arcane Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background-color: #1a1a1a;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            background: white;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        header {
            text-align: center;
            border-bottom: 3px solid #2c3e50;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #7f8c8d;
            font-style: italic;
            font-size: 0.9em;
        }

        .section {
            margin-bottom: 30px;
            border: 1px solid #ecf0f1;
            border-left: 4px solid #3498db;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 1px solid #bdc3c7;
            padding-bottom: 8px;
        }

        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .three-columns {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.95em;
            color: #2c3e50;
            background-color: white;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: 'Arial', sans-serif;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
            background-color: #ecf7ff;
        }

        /* Drag and Drop Styles */
        .ability-input {
            transition: all 0.2s ease;
        }

        .ability-input.drag-over {
            border-color: #f39c12 !important;
            border-width: 3px;
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.6) !important;
            background-color: #fff9e6 !important;
            transform: scale(1.05);
        }

        .score-dragging {
            opacity: 0.7;
            transform: scale(0.95);
            cursor: grabbing;
        }

        .score-button-container {
            perspective: 1000px;
        }

        .ability-scores {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }

        .ability-score {
            text-align: center;
        }

        .ability-score input {
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .ability-name {
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
            color: #7f8c8d;
        }

        .skills-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .skill-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .skill-checkbox input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .skill-checkbox label {
            margin: 0;
            font-weight: normal;
            text-transform: none;
            cursor: pointer;
        }

        .character-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .summary-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
        }

        .summary-value {
            font-size: 1.2em;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .two-columns, .three-columns {
                grid-template-columns: 1fr;
            }

            .ability-scores {
                grid-template-columns: repeat(3, 1fr);
            }

            .skills-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .summary-row {
                grid-template-columns: 1fr 1fr;
            }
        }

        @keyframes pulse-success {
            0% {
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(46, 204, 113, 0);
                transform: scale(1.02);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
                transform: scale(1);
            }
        }

        @keyframes drag-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                padding: 20px;
            }

            input[type="text"],
            input[type="number"],
            textarea,
            select {
                border: 1px solid #333;
                background: white;
            }
        }

        .help-text {
            font-size: 0.8em;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 3px;
        }

        .button-group {
            text-align: center;
            margin-top: 40px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1em;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background-color: #95a5a6;
        }

        button.secondary:hover {
            background-color: #7f8c8d;
        }

        button[style*="linear-gradient"] {
            padding: 14px 20px;
            font-size: 0.95em;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        button[style*="linear-gradient"]:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
        }

        button[style*="linear-gradient"]:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

        .instructions {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 30px;
            color: #856404;
        }

        .instructions h3 {
            margin-bottom: 10px;
        }

        .instructions ul {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öîÔ∏è D&D 5e Character Sheet</h1>
            <p class="subtitle">Arcane Engine - Character Planning Template</p>
        </header>

        <div class="instructions">
            <h3>üìã How to Use This Template</h3>
            <ul>
                <li>Fill out all fields completely before submitting</li>
                <li>Use ability scores between 3 and 18 (after modifiers)</li>
                <li>Select up to 5 skills for your character</li>
                <li>Write your backstory, personality, and motivations in detail</li>
                <li>Save this file and upload it to Arcane Engine</li>
                <li>Click "Print" to get a PDF copy for your records</li>
            </ul>
        </div>

        <!-- BASIC INFORMATION -->
        <div class="section">
            <div class="section-title">üë§ Basic Information</div>
            <div class="two-columns">
                <div class="form-group">
                    <label for="characterName">Character Name *</label>
                    <input type="text" id="characterName" placeholder="e.g., Aragorn Stormborn">
                </div>
                <div class="form-group">
                    <label for="playerName">Your Name (Player) *</label>
                    <input type="text" id="playerName" placeholder="Your name">
                </div>
            </div>
        </div>

        <!-- CHARACTER SUMMARY -->
        <div class="character-summary">
            <div class="summary-row">
                <div class="summary-item">
                    <div class="summary-label">Race</div>
                    <div class="summary-value"><span id="raceSummary">-</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Class</div>
                    <div class="summary-value"><span id="classSummary">-</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Background</div>
                    <div class="summary-value"><span id="backgroundSummary">-</span></div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Alignment</div>
                    <div class="summary-value"><span id="alignmentSummary">-</span></div>
                </div>
            </div>
        </div>

        <!-- RACE & CLASS -->
        <div class="section">
            <div class="section-title">üé≠ Race & Class</div>
            <div class="two-columns">
                <div class="form-group">
                    <label for="race">Race *</label>
                    <select id="race" onchange="displayRacialBonuses()">
                        <option value="">Select a race...</option>
                        <option value="Dragonborn">Dragonborn</option>
                        <option value="Dwarf">Dwarf</option>
                        <option value="Elf">Elf</option>
                        <option value="Gnome">Gnome</option>
                        <option value="Half-Elf">Half-Elf</option>
                        <option value="Half-Orc">Half-Orc</option>
                        <option value="Halfling">Halfling</option>
                        <option value="Human">Human</option>
                        <option value="Tiefling">Tiefling</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="class">Class *</label>
                    <select id="class" onchange="displayClassProficiencies()">
                        <option value="">Select a class...</option>
                        <option value="Barbarian">Barbarian</option>
                        <option value="Bard">Bard</option>
                        <option value="Cleric">Cleric</option>
                        <option value="Druid">Druid</option>
                        <option value="Fighter">Fighter</option>
                        <option value="Monk">Monk</option>
                        <option value="Paladin">Paladin</option>
                        <option value="Ranger">Ranger</option>
                        <option value="Rogue">Rogue</option>
                        <option value="Sorcerer">Sorcerer</option>
                        <option value="Warlock">Warlock</option>
                        <option value="Wizard">Wizard</option>
                    </select>
                </div>
            </div>
            
            <!-- Racial Bonuses Display -->
            <div id="racialBonusesDisplay" style="margin-top: 15px; padding: 15px; background-color: #f9f5f0; border: 1px solid #ddd; border-radius: 4px; display: none;">
                <div style="font-weight: bold; color: #2c3e50; margin-bottom: 10px;">üß¨ Racial Ability Bonuses</div>
                <div id="racialBonusesContent"></div>
            </div>
            
            <!-- Class Skill Proficiencies Display -->
            <div id="classProficienciesDisplay" style="margin-top: 15px; padding: 15px; background-color: #f0f8f5; border: 1px solid #ddd; border-radius: 4px; display: none;">
                <div style="font-weight: bold; color: #2c3e50; margin-bottom: 10px;">üéØ Class Information</div>
                <div id="classProficienciesContent"></div>
            </div>
            
            <!-- Background Attributes Display -->
            <div id="backgroundAttributesDisplay" style="margin-top: 15px; padding: 15px; background-color: #faf8f3; border: 1px solid #ddd; border-radius: 4px; display: none;">
                <div style="font-weight: bold; color: #2c3e50; margin-bottom: 10px;">üìñ Background Details</div>
                <div id="backgroundAttributesContent"></div>
            </div>
            <div class="two-columns">
                <div class="form-group">
                    <label for="background">Background *</label>
                    <select id="background" onchange="displayBackgroundAttributes()">
                        <option value="">Select a background...</option>
                        <option value="Acolyte">Acolyte</option>
                        <option value="Charlatan">Charlatan</option>
                        <option value="Criminal">Criminal</option>
                        <option value="Entertainer">Entertainer</option>
                        <option value="Folk Hero">Folk Hero</option>
                        <option value="Guild Artisan">Guild Artisan</option>
                        <option value="Hermit">Hermit</option>
                        <option value="Noble">Noble</option>
                        <option value="Outlander">Outlander</option>
                        <option value="Sage">Sage</option>
                        <option value="Sailor">Sailor</option>
                        <option value="Soldier">Soldier</option>
                        <option value="Urchin">Urchin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="alignment">Alignment *</label>
                    <select id="alignment">
                        <option value="">Select an alignment...</option>
                        <option value="Lawful Good">Lawful Good</option>
                        <option value="Neutral Good">Neutral Good</option>
                        <option value="Chaotic Good">Chaotic Good</option>
                        <option value="Lawful Neutral">Lawful Neutral</option>
                        <option value="True Neutral">True Neutral</option>
                        <option value="Chaotic Neutral">Chaotic Neutral</option>
                        <option value="Lawful Evil">Lawful Evil</option>
                        <option value="Neutral Evil">Neutral Evil</option>
                        <option value="Chaotic Evil">Chaotic Evil</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ABILITY SCORES -->
        <div class="section">
            <div class="section-title">üí™ Ability Scores</div>
            <p class="help-text" style="margin-bottom: 15px;">Enter scores between 3 and 18. Use the options below to generate or apply scores.</p>
            
            <!-- Score Generation Options -->
            <div style="background: #ecf7ff; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #3498db;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <button type="button" onclick="rollAbilityScores()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">üé≤ Roll 4d6 Drop Lowest</button>
                    <button type="button" onclick="applyStandardArray()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">‚ö° Apply Standard Array</button>
                </div>
                <div id="rollResults" style="display: none; padding: 10px; background: white; border-radius: 4px; margin-bottom: 10px; border-left: 4px solid #3498db;">
                    <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">üé≤ Rolled Scores (click to assign):</div>
                    <div id="rolledScoresDisplay" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;"></div>
                </div>
            </div>

            <p class="help-text" style="margin-bottom: 15px; font-size: 0.85em;">üí° Tip: You can click scores to assign, or drag them directly to an ability box!</p>
            
            <div class="ability-scores">
                <div class="ability-score">
                    <div class="ability-name">Strength</div>
                    <input type="number" id="strength" value="10" min="3" max="18" class="ability-input" data-ability="Strength">
                </div>
                <div class="ability-score">
                    <div class="ability-name">Dexterity</div>
                    <input type="number" id="dexterity" value="10" min="3" max="18" class="ability-input" data-ability="Dexterity">
                </div>
                <div class="ability-score">
                    <div class="ability-name">Constitution</div>
                    <input type="number" id="constitution" value="10" min="3" max="18" class="ability-input" data-ability="Constitution">
                </div>
                <div class="ability-score">
                    <div class="ability-name">Intelligence</div>
                    <input type="number" id="intelligence" value="10" min="3" max="18" class="ability-input" data-ability="Intelligence">
                </div>
                <div class="ability-score">
                    <div class="ability-name">Wisdom</div>
                    <input type="number" id="wisdom" value="10" min="3" max="18" class="ability-input" data-ability="Wisdom">
                </div>
                <div class="ability-score">
                    <div class="ability-name">Charisma</div>
                    <input type="number" id="charisma" value="10" min="3" max="18" class="ability-input" data-ability="Charisma">
                </div>
            </div>
        </div>

        <!-- SKILLS & PROFICIENCIES -->
        <div class="section">
            <div class="section-title">üéØ Skills & Proficiencies</div>
            <p class="help-text" style="margin-bottom: 15px;">Select up to 5 skills your character is proficient in</p>
            <div class="skills-grid">
                <div class="skill-checkbox">
                    <input type="checkbox" id="acrobatics" value="Acrobatics">
                    <label for="acrobatics">Acrobatics</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="animalHandling" value="Animal Handling">
                    <label for="animalHandling">Animal Handling</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="arcana" value="Arcana">
                    <label for="arcana">Arcana</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="athletics" value="Athletics">
                    <label for="athletics">Athletics</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="deception" value="Deception">
                    <label for="deception">Deception</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="history" value="History">
                    <label for="history">History</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="insight" value="Insight">
                    <label for="insight">Insight</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="intimidation" value="Intimidation">
                    <label for="intimidation">Intimidation</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="investigation" value="Investigation">
                    <label for="investigation">Investigation</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="medicine" value="Medicine">
                    <label for="medicine">Medicine</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="nature" value="Nature">
                    <label for="nature">Nature</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="perception" value="Perception">
                    <label for="perception">Perception</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="performance" value="Performance">
                    <label for="performance">Performance</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="persuasion" value="Persuasion">
                    <label for="persuasion">Persuasion</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="religion" value="Religion">
                    <label for="religion">Religion</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="sleightOfHand" value="Sleight of Hand">
                    <label for="sleightOfHand">Sleight of Hand</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="stealth" value="Stealth">
                    <label for="stealth">Stealth</label>
                </div>
                <div class="skill-checkbox">
                    <input type="checkbox" id="survival" value="Survival">
                    <label for="survival">Survival</label>
                </div>
            </div>
        </div>

        <!-- CHARACTER STORY -->
        <div class="section">
            <div class="section-title">üìñ Character Story</div>
            <div class="form-group">
                <label for="backgroundStory">Background Story *</label>
                <textarea id="backgroundStory" placeholder="Describe your character's history, motivations, and how they came to be. What major events shaped them? What drives them forward?"></textarea>
            </div>
        </div>

        <!-- CHARACTER PERSONALITY -->
        <div class="section">
            <div class="section-title">‚ú® Personality & Character</div>
            <div class="form-group">
                <label for="personalityTraits">Personality Traits</label>
                <textarea id="personalityTraits" placeholder="e.g., I'm disciplined and follow orders without question."></textarea>
            </div>
            <div class="form-group">
                <label for="ideals">Ideals</label>
                <textarea id="ideals" placeholder="e.g., Responsibility. I do what I must to protect those who cannot protect themselves."></textarea>
            </div>
            <div class="form-group">
                <label for="bonds">Bonds</label>
                <textarea id="bonds" placeholder="e.g., I owe a debt to a fellow soldier who saved my life."></textarea>
            </div>
            <div class="form-group">
                <label for="flaws">Flaws</label>
                <textarea id="flaws" placeholder="e.g., I have difficulty trusting those who haven't proven themselves in battle."></textarea>
            </div>
        </div>

        <!-- EQUIPMENT -->
        <div class="section">
            <div class="section-title">üéí Equipment & Final Notes</div>
            <div class="form-group">
                <label for="equipment">Equipment Notes</label>
                <textarea id="equipment" placeholder="List your starting equipment. e.g., Longsword, Shield, Plate Armor, Backpack with 10 days rations"></textarea>
            </div>
        </div>

        <!-- BUTTONS -->
        <div class="button-group">
            <button onclick="downloadJSON()">üì• Download as JSON</button>
            <button onclick="downloadCharacterPackage()">üì¶ Download Package (JSON + PDF)</button>
            <button class="secondary" onclick="window.print()">üñ®Ô∏è Print as PDF</button>
            <button class="secondary" onclick="clearForm()">üîÑ Clear Form</button>
        </div>
    </div>

    <script>
        // ============================================================================
        // GLOBAL VARIABLES - MUST BE AT TOP SCOPE
        // ============================================================================
        
        let rolledScores = [];
        let usedScoreIndices = new Set();
        let draggedScore = null;
        let draggedScoreIndex = null;
        
        // ============================================================================
        // RULESET INTEGRATION
        // ============================================================================
        
        let rulesetData = {
            races: [],
            classes: [],
            skills: []
        };
        
        // Fetch ruleset data on page load
        async function loadRulesetData() {
            try {
                // Only try to fetch if we have a valid protocol (not file://)
                if (window.location.protocol === 'file:') {
                    console.log('Offline mode: HTML opened directly, skipping API fetch');
                    return;
                }
                
                // Try to fetch from local API if available
                const raceRes = await fetch('/api/rules/races?limit=50').catch(() => null);
                const classRes = await fetch('/api/rules/classes?limit=50').catch(() => null);
                
                if (raceRes?.ok) rulesetData.races = await raceRes.json();
                if (classRes?.ok) rulesetData.classes = await classRes.json();
                
                console.log('Ruleset data loaded:', rulesetData);
            } catch (e) {
                console.log('Ruleset API not available (offline mode)', e);
            }
        }
        
        // Get racial bonuses for selected race
        function getRacialBonuses(raceName) {
            const race = rulesetData.races.find(r => 
                r.name?.toLowerCase() === raceName?.toLowerCase()
            );
            
            if (!race) return null;
            
            // Parse ability bonuses if available
            const bonuses = {};
            if (race.data_json) {
                try {
                    const data = typeof race.data_json === 'string' ? 
                        JSON.parse(race.data_json) : race.data_json;
                    if (data.ability_bonuses) return data.ability_bonuses;
                } catch (e) {
                    console.log('Could not parse race bonuses');
                }
            }
            return bonuses;
        }
        
        // Get class attributes for selected class
        function getClassAttributes(className) {
            const classData = rulesetData.classes.find(c => 
                c.name?.toLowerCase() === className?.toLowerCase()
            );
            
            if (!classData) return null;
            
            // Parse class attributes if available
            const attributes = {};
            if (classData.data_json) {
                try {
                    const data = typeof classData.data_json === 'string' ? 
                        JSON.parse(classData.data_json) : classData.data_json;
                    
                    // Extract useful class attributes
                    return {
                        hit_die: data.hit_die || 'd8',
                        saving_throws: data.saving_throws || [],
                        class_features: data.class_features || []
                    };
                } catch (e) {
                    console.log('Could not parse class attributes');
                }
            }
            return attributes;
        }
        
        // Get background attributes for selected background
        function getBackgroundAttributes(backgroundName) {
            // Since background data might not be in ruleset, provide defaults
            const backgroundData = {
                'Acolyte': {
                    skill_proficiencies: ['Insight', 'Religion'],
                    languages: ['One of your choice'],
                    equipment: 'Holy symbol, prayer book, 5 gp'
                },
                'Charlatan': {
                    skill_proficiencies: ['Deception', 'Sleight of Hand'],
                    languages: ['Thieves\' cant'],
                    equipment: 'Fine clothes, disguise kit, 15 gp'
                },
                'Criminal': {
                    skill_proficiencies: ['Deception', 'Stealth'],
                    languages: ['Thieves\' cant'],
                    equipment: 'Crowbar, dark common clothes, 15 gp'
                },
                'Entertainer': {
                    skill_proficiencies: ['Acrobatics', 'Performance'],
                    languages: ['One of your choice'],
                    equipment: 'Costume, musical instrument, 15 gp'
                },
                'Folk Hero': {
                    skill_proficiencies: ['Animal Handling', 'Survival'],
                    languages: ['One of your choice'],
                    equipment: 'Artisan\'s tools, shovel, 10 gp'
                },
                'Guild Artisan': {
                    skill_proficiencies: ['Insight', 'Persuasion'],
                    languages: ['One of your choice'],
                    equipment: 'Artisan\'s tools, guild documents, 15 gp'
                },
                'Hermit': {
                    skill_proficiencies: ['Medicine', 'Religion'],
                    languages: ['One of your choice'],
                    equipment: 'Scroll case, winter blanket, common clothes, 5 gp'
                },
                'Noble': {
                    skill_proficiencies: ['Insight', 'Persuasion'],
                    languages: ['One of your choice'],
                    equipment: 'Fine clothes, signet ring, scroll of pedigree, 25 gp'
                },
                'Outlander': {
                    skill_proficiencies: ['Athletics', 'Survival'],
                    languages: ['One of your choice'],
                    equipment: 'Bedroll, rope, 50 feet, common clothes, 10 gp'
                },
                'Sage': {
                    skill_proficiencies: ['Arcana', 'History'],
                    languages: ['Two of your choice'],
                    equipment: 'Bottle of black ink, quill, small knife, letter book, 10 gp'
                },
                'Sailor': {
                    skill_proficiencies: ['Athletics', 'Perception'],
                    languages: ['One of your choice'],
                    equipment: 'Belaying pin (club), silk rope (50 ft), lucky charm, common clothes, 10 gp'
                },
                'Soldier': {
                    skill_proficiencies: ['Athletics', 'Intimidation'],
                    languages: ['One of your choice'],
                    equipment: 'Insignia of rank, gaming set, common clothes, 10 gp'
                },
                'Urchin': {
                    skill_proficiencies: ['Sleight of Hand', 'Stealth'],
                    languages: ['Thieves\' cant'],
                    equipment: 'Small knife, map of city streets, pet mouse, token to remember parents, 10 gp'
                }
            };
            
            return backgroundData[backgroundName] || null;
        }
        
        // Display racial bonuses when race changes
        function displayRacialBonuses() {
            const race = document.getElementById('race').value;
            const bonusContainer = document.getElementById('racialBonusesDisplay');
            const bonusContent = document.getElementById('racialBonusesContent');
            
            if (!race || !bonusContainer) {
                if (bonusContainer) bonusContainer.style.display = 'none';
                return;
            }
            
            const bonuses = getRacialBonuses(race);
            
            if (!bonuses || Object.keys(bonuses).length === 0) {
                bonusContent.innerHTML = '<p style="color: #7f8c8d; font-size: 0.9em;">No bonuses found (offline mode)</p>';
                bonusContainer.style.display = 'block';
                return;
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">';
            const abilityMap = {
                'str': 'Strength',
                'dex': 'Dexterity',
                'con': 'Constitution',
                'int': 'Intelligence',
                'wis': 'Wisdom',
                'cha': 'Charisma'
            };
            
            let hasBonus = false;
            for (const [ability, bonus] of Object.entries(bonuses)) {
                const abilityName = abilityMap[ability] || ability;
                if (bonus > 0) {
                    hasBonus = true;
                    html += `<div style="padding: 8px; background: #e8f4f8; border-radius: 4px; text-align: center;">
                        <strong>${abilityName}</strong>
                        <div style="color: #3498db; font-weight: bold; font-size: 1.2em;">+${bonus}</div>
                    </div>`;
                }
            }
            html += '</div>';
            
            if (hasBonus) {
                bonusContent.innerHTML = html;
                bonusContainer.style.display = 'block';
            } else {
                bonusContainer.style.display = 'none';
            }
        }
        
        // Display class skill proficiencies when class changes
        function displayClassProficiencies() {
            const className = document.getElementById('class').value;
            const profContainer = document.getElementById('classProficienciesDisplay');
            const profContent = document.getElementById('classProficienciesContent');
            
            if (!className || !profContainer) {
                if (profContainer) profContainer.style.display = 'none';
                return;
            }
            
            const profs = getClassProficiencies(className);
            const attrs = getClassAttributes(className);
            
            if ((!profs || profs.length === 0) && (!attrs || Object.keys(attrs).length === 0)) {
                profContent.innerHTML = '<p style="color: #7f8c8d; font-size: 0.9em;">No proficiencies found (offline mode)</p>';
                profContainer.style.display = 'block';
                return;
            }
            
            let html = '<div style="display: grid; grid-template-columns: 1fr; gap: 15px;">';
            
            // Class Attributes
            if (attrs && Object.keys(attrs).length > 0) {
                html += '<div style="background: #f0f8ff; padding: 10px; border-left: 3px solid #3498db; border-radius: 2px;">';
                html += '<div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">‚öîÔ∏è Class Features</div>';
                if (attrs.hit_die) {
                    html += `<div style="padding: 4px 0; font-size: 0.95em;">Hit Die: <strong>${attrs.hit_die}</strong></div>`;
                }
                if (attrs.saving_throws && attrs.saving_throws.length > 0) {
                    html += `<div style="padding: 4px 0; font-size: 0.95em;">Saving Throws: <strong>${attrs.saving_throws.join(', ') || 'See class'}</strong></div>`;
                }
                html += '</div>';
            }
            
            // Skill Proficiencies
            if (profs && profs.length > 0) {
                html += '<div style="background: #f0f8ff; padding: 10px; border-left: 3px solid #3498db; border-radius: 2px;">';
                html += '<div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">üéØ Skill Proficiencies</div>';
                html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">';
                for (const prof of profs) {
                    if (prof) {
                        html += `<div style="padding: 4px 8px; background: #e8f4f8; border-radius: 2px;">‚úì ${prof}</div>`;
                    }
                }
                html += '</div></div>';
            }
            
            html += '</div>';
            
            profContent.innerHTML = html;
            profContainer.style.display = 'block';
        }
        
        // Display background attributes when background changes
        function displayBackgroundAttributes() {
            const backgroundName = document.getElementById('background').value;
            const bgContainer = document.getElementById('backgroundAttributesDisplay');
            const bgContent = document.getElementById('backgroundAttributesContent');
            
            if (!backgroundName || !bgContainer) {
                if (bgContainer) bgContainer.style.display = 'none';
                return;
            }
            
            const bgAttrs = getBackgroundAttributes(backgroundName);
            
            if (!bgAttrs) {
                bgContent.innerHTML = '<p style="color: #7f8c8d; font-size: 0.9em;">No attributes found</p>';
                bgContainer.style.display = 'block';
                return;
            }
            
            let html = '<div style="display: grid; grid-template-columns: 1fr; gap: 10px;">';
            
            // Skill Proficiencies
            if (bgAttrs.skill_proficiencies && bgAttrs.skill_proficiencies.length > 0) {
                html += '<div style="background: #f5f0f0; padding: 10px; border-left: 3px solid #e74c3c; border-radius: 2px;">';
                html += '<div style="font-weight: bold; color: #2c3e50; margin-bottom: 6px;">üìö Skill Proficiencies</div>';
                html += '<div>';
                for (const skill of bgAttrs.skill_proficiencies) {
                    html += `<div style="padding: 2px 0; font-size: 0.95em;">‚úì ${skill}</div>`;
                }
                html += '</div></div>';
            }
            
            // Languages
            if (bgAttrs.languages && bgAttrs.languages.length > 0) {
                html += '<div style="background: #f5f0f0; padding: 10px; border-left: 3px solid #e74c3c; border-radius: 2px;">';
                html += '<div style="font-weight: bold; color: #2c3e50; margin-bottom: 6px;">üó£Ô∏è Languages</div>';
                html += '<div>';
                for (const lang of bgAttrs.languages) {
                    html += `<div style="padding: 2px 0; font-size: 0.95em;">‚Ä¢ ${lang}</div>`;
                }
                html += '</div></div>';
            }
            
            // Equipment
            if (bgAttrs.equipment) {
                html += '<div style="background: #f5f0f0; padding: 10px; border-left: 3px solid #e74c3c; border-radius: 2px;">';
                html += '<div style="font-weight: bold; color: #2c3e50; margin-bottom: 6px;">üéí Starting Equipment</div>';
                html += `<div style="font-size: 0.95em;">${bgAttrs.equipment}</div></div>`;
            }
            
            html += '</div>';
            
            bgContent.innerHTML = html;
            bgContainer.style.display = 'block';
        }
        
        // Load ruleset data when page loads
        document.addEventListener('DOMContentLoaded', loadRulesetData);

        // ============================================================================
        // DICE ROLLING & ABILITY SCORES
        // ============================================================================

        // Dice rolling function
        function rollAbilityScores() {
            rolledScores = [];
            usedScoreIndices.clear();  // Reset used score indices for new roll
            
            // Roll 6 times (4d6 drop lowest)
            for (let i = 0; i < 6; i++) {
                let rolls = [
                    Math.floor(Math.random() * 6) + 1,
                    Math.floor(Math.random() * 6) + 1,
                    Math.floor(Math.random() * 6) + 1,
                    Math.floor(Math.random() * 6) + 1
                ];
                
                // Drop the lowest
                rolls.sort((a, b) => b - a);
                rolls.pop();
                
                // Sum remaining
                let score = rolls.reduce((a, b) => a + b, 0);
                rolledScores.push(score);
            }
            
            // Sort highest to lowest for display
            rolledScores.sort((a, b) => b - a);
            
            // Display results
            displayRolledScores();
        }

        function displayRolledScores() {
            const display = document.getElementById('rolledScoresDisplay');
            display.innerHTML = '';
            
            rolledScores.forEach((score, index) => {
                const container = document.createElement('div');
                container.className = 'score-button-container';
                
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.draggable = true;
                btn.dataset.scoreIndex = index;  // Simple index 0-5
                btn.dataset.score = score;  // The numeric value
                btn.style.cssText = `
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    padding: 12px;
                    border-radius: 4px;
                    font-weight: bold;
                    font-size: 1.1em;
                    cursor: grab;
                    transition: all 0.2s ease;
                    width: 100%;
                `;
                btn.innerHTML = `<div>${score}</div>`;
                
                // Click to assign
                btn.onclick = (e) => {
                    e.preventDefault();
                    assignToAbilityFromRoll(score, index);
                };
                
                // Drag events
                btn.addEventListener('dragstart', handleDragStart);
                btn.addEventListener('dragend', handleDragEnd);
                
                btn.onmouseover = function() { 
                    if (!this.classList.contains('score-dragging')) {
                        this.style.transform = 'scale(1.05)';
                    }
                };
                btn.onmouseout = function() { 
                    if (!this.classList.contains('score-dragging')) {
                        this.style.transform = 'scale(1)';
                    }
                };
                
                container.appendChild(btn);
                display.appendChild(container);
            });
            
            // Setup drag over listeners on ability inputs
            setupAbilityInputDragListeners();
            
            // Show results section
            document.getElementById('rollResults').style.display = 'block';
            
            // Log results for player reference
            console.log('üé≤ Rolled Ability Scores:', rolledScores);
        }

        // ============================================================================
        // DRAG AND DROP FUNCTIONS
        // ============================================================================

        function handleDragStart(e) {
            // Don't allow dragging already-used scores
            const scoreIndex = e.target.dataset.scoreIndex;
            if (e.target.disabled || usedScoreIndices.has(parseInt(scoreIndex))) {
                e.preventDefault();
                return;
            }
            
            draggedScore = e.target.dataset.score;
            draggedScoreIndex = scoreIndex;
            e.target.classList.add('score-dragging');
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', draggedScore);
            e.dataTransfer.setData('scoreIndex', scoreIndex);
            
            // Create custom drag image
            const img = new Image();
            img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="40" height="40"%3E%3Crect fill="%23667eea" width="40" height="40" rx="4"/%3E%3Ctext x="20" y="26" text-anchor="middle" font-size="20" fill="white" font-weight="bold"%3E' + draggedScore + '%3C/text%3E%3C/svg%3E';
            e.dataTransfer.setDragImage(img, 20, 20);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('score-dragging');
            draggedScore = null;
            draggedScoreIndex = null;
            
            // Remove all drag-over classes
            document.querySelectorAll('.ability-input').forEach(input => {
                input.classList.remove('drag-over');
            });
        }

        function setupAbilityInputDragListeners() {
            document.querySelectorAll('.ability-input').forEach(input => {
                input.addEventListener('dragover', handleDragOver);
                input.addEventListener('drop', handleDrop);
                input.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            e.target.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            const score = e.dataTransfer.getData('text/plain');
            const scoreIndex = parseInt(e.dataTransfer.getData('scoreIndex'));
            const ability = e.target.dataset.ability;
            
            if (score && ability && scoreIndex !== undefined && !isNaN(scoreIndex)) {
                // Check if this specific score index is already used
                if (usedScoreIndices.has(scoreIndex)) {
                    alert('‚ö†Ô∏è This score has already been assigned! Please choose a different score.');
                    return;
                }
                
                e.target.value = score;
                e.target.dispatchEvent(new Event('input', { bubbles: true }));
                e.target.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Mark this specific score as used
                usedScoreIndices.add(scoreIndex);
                disableScoreButton(scoreIndex);
                
                // Visual feedback
                e.target.style.animation = 'none';
                setTimeout(() => {
                    e.target.style.animation = 'pulse-success 0.6s ease';
                }, 10);
            }
        }

        function disableScoreButton(scoreIndex) {
            // Find and disable the button with this specific index
            document.querySelectorAll('.score-button-container button').forEach(btn => {
                if (parseInt(btn.dataset.scoreIndex) === scoreIndex) {
                    btn.disabled = true;
                    btn.style.opacity = '0.4';
                    btn.style.cursor = 'not-allowed';
                    btn.title = '‚úì Already assigned';
                    
                    // Add visual indicator
                    const score = btn.dataset.score;
                    btn.innerHTML = `<div>${score} ‚úì</div>`;
                }
            });
        }

        function enableScoreButton(scoreIndex) {
            // Find and enable the button with this specific index
            document.querySelectorAll('.score-button-container button').forEach(btn => {
                if (parseInt(btn.dataset.scoreIndex) === scoreIndex) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'grab';
                    btn.title = '';
                    const score = btn.dataset.score;
                    btn.innerHTML = `<div>${score}</div>`;
                }
            });
        }

        function assignToAbility(ability, score) {
            const abilityId = ability.toLowerCase();
            document.getElementById(abilityId).value = score;
            
            // Show confirmation
            alert(`‚úì Assigned ${score} to ${ability}`);
        }

        function assignToAbilityFromRoll(score, scoreIndex) {
            // Prevent assigning already-used scores
            if (usedScoreIndices.has(scoreIndex)) {
                alert('‚ö†Ô∏è This score has already been assigned! Please choose a different score.');
                return;
            }
            
            const abilities = ['Strength', 'Dexterity', 'Constitution', 'Intelligence', 'Wisdom', 'Charisma'];
            let selectedAbility = null;
            
            // Create a simple dialog to select ability
            const abilityList = abilities.map((a, i) => `${i + 1}. ${a}`).join('\n');
            const choice = prompt(`Assign score ${score} to which ability?\n\n${abilityList}`, '1');
            
            if (choice) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < abilities.length) {
                    selectedAbility = abilities[index];
                    const abilityId = selectedAbility.toLowerCase();
                    const input = document.getElementById(abilityId);
                    
                    input.value = score;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // Mark as used
                    usedScoreIndices.add(scoreIndex);
                    disableScoreButton(scoreIndex);
                    
                    // Show success with animation
                    input.style.animation = 'none';
                    setTimeout(() => {
                        input.style.animation = 'pulse-success 0.6s ease';
                    }, 10);
                }
            }
        }

        function applyStandardArray() {
            // Clear any used scores tracking
            usedScoreIndices.clear();
            rolledScores = [];
            
            // Re-enable all score buttons
            document.querySelectorAll('.score-button-container button').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'grab';
                btn.title = '';
                const score = btn.dataset.score;
                btn.innerHTML = `<div>${score}</div>`;
            });
            
            // Standard array: 15, 14, 13, 12, 10, 8
            const standardArray = [15, 14, 13, 12, 10, 8];
            
            document.getElementById('strength').value = standardArray[0];
            document.getElementById('dexterity').value = standardArray[1];
            document.getElementById('constitution').value = standardArray[2];
            document.getElementById('intelligence').value = standardArray[3];
            document.getElementById('wisdom').value = standardArray[4];
            document.getElementById('charisma').value = standardArray[5];
            
            // Hide roll results
            document.getElementById('rollResults').style.display = 'none';
            
            // Show confirmation
            alert('‚úì Standard array applied! (15, 14, 13, 12, 10, 8)\n\nYou can rearrange the values by editing each field.');
        }

        // Auto-update summary
        document.getElementById('race').addEventListener('change', (e) => {
            document.getElementById('raceSummary').textContent = e.target.value || '-';
        });
        document.getElementById('class').addEventListener('change', (e) => {
            document.getElementById('classSummary').textContent = e.target.value || '-';
        });
        document.getElementById('background').addEventListener('change', (e) => {
            document.getElementById('backgroundSummary').textContent = e.target.value || '-';
        });
        document.getElementById('alignment').addEventListener('change', (e) => {
            document.getElementById('alignmentSummary').textContent = e.target.value || '-';
        });

        // Download as JSON
        function downloadJSON() {
            const characterData = {
                player_name: document.getElementById('playerName').value,
                character_name: document.getElementById('characterName').value,
                race: document.getElementById('race').value,
                class_name: document.getElementById('class').value,
                background: document.getElementById('background').value,
                alignment: document.getElementById('alignment').value,
                level: 1,
                ability_scores: {
                    strength: parseInt(document.getElementById('strength').value),
                    dexterity: parseInt(document.getElementById('dexterity').value),
                    constitution: parseInt(document.getElementById('constitution').value),
                    intelligence: parseInt(document.getElementById('intelligence').value),
                    wisdom: parseInt(document.getElementById('wisdom').value),
                    charisma: parseInt(document.getElementById('charisma').value),
                },
                skills: Array.from(document.querySelectorAll('.skill-checkbox input:checked')).map(cb => cb.value),
                background_story: document.getElementById('backgroundStory').value,
                personality_traits: document.getElementById('personalityTraits').value,
                ideals: document.getElementById('ideals').value,
                bonds: document.getElementById('bonds').value,
                flaws: document.getElementById('flaws').value,
                equipment_notes: document.getElementById('equipment').value,
                created_at: new Date().toISOString(),
                last_played: null,
            };

            const dataStr = JSON.stringify(characterData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            
            // Create filename with character and player name
            const playerName = (characterData.player_name || 'player').replace(/[^a-zA-Z0-9]/g, '_');
            const charName = (characterData.character_name || 'character').replace(/[^a-zA-Z0-9]/g, '_');
            const date = new Date().toISOString().split('T')[0];
            link.download = `${charName}-${playerName}-${date}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // Show confirmation
            alert(`‚úÖ Character saved as:\n"${link.download}"\n\nüìÅ Save to a local folder like:\nMyCharacters/${playerName}/${charName}/`);
        }

        function downloadCharacterPackage() {
            // Download character data + trigger PDF print
            const characterData = {
                player_name: document.getElementById('playerName').value,
                character_name: document.getElementById('characterName').value,
                race: document.getElementById('race').value,
                class_name: document.getElementById('class').value,
                background: document.getElementById('background').value,
                alignment: document.getElementById('alignment').value,
                level: 1,
                ability_scores: {
                    strength: parseInt(document.getElementById('strength').value),
                    dexterity: parseInt(document.getElementById('dexterity').value),
                    constitution: parseInt(document.getElementById('constitution').value),
                    intelligence: parseInt(document.getElementById('intelligence').value),
                    wisdom: parseInt(document.getElementById('wisdom').value),
                    charisma: parseInt(document.getElementById('charisma').value),
                },
                skills: Array.from(document.querySelectorAll('.skill-checkbox input:checked')).map(cb => cb.value),
                background_story: document.getElementById('backgroundStory').value,
                personality_traits: document.getElementById('personalityTraits').value,
                ideals: document.getElementById('ideals').value,
                bonds: document.getElementById('bonds').value,
                flaws: document.getElementById('flaws').value,
                equipment_notes: document.getElementById('equipment').value,
                created_at: new Date().toISOString(),
                last_played: null,
            };

            const playerName = (characterData.player_name || 'player').replace(/[^a-zA-Z0-9]/g, '_');
            const charName = (characterData.character_name || 'character').replace(/[^a-zA-Z0-9]/g, '_');
            
            // Step 1: Download JSON
            const jsonStr = JSON.stringify(characterData, null, 2);
            const jsonBlob = new Blob([jsonStr], { type: 'application/json' });
            const jsonUrl = URL.createObjectURL(jsonBlob);
            const jsonLink = document.createElement('a');
            jsonLink.href = jsonUrl;
            jsonLink.download = `character-data.json`;
            document.body.appendChild(jsonLink);
            jsonLink.click();
            document.body.removeChild(jsonLink);
            URL.revokeObjectURL(jsonUrl);
            
            // Step 2: Trigger PDF print after JSON download
            setTimeout(() => {
                // Create printable HTML version of character sheet
                const printWindow = window.open('', '', 'width=900,height=1200');
                
                const printContent = `
<!DOCTYPE html>
<html>
<head>
    <title>${characterData.character_name} - Character Sheet</title>
    <style>
        body {
            font-family: 'Georgia', serif;
            color: #333;
            margin: 20px;
            line-height: 1.6;
        }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #7f8c8d; font-style: italic; margin-bottom: 20px; }
        .header-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; border-bottom: 2px solid #2c3e50; padding-bottom: 15px; }
        .header-item { }
        .header-label { font-weight: bold; color: #2c3e50; }
        .section { margin-bottom: 20px; }
        .section-title { font-size: 1.2em; font-weight: bold; color: #2c3e50; margin-bottom: 10px; border-bottom: 1px solid #bdc3c7; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #bdc3c7; padding: 8px; text-align: left; }
        th { background-color: #ecf0f1; font-weight: bold; }
        .ability-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; }
        .ability-box { border: 2px solid #3498db; padding: 10px; border-radius: 4px; }
        .ability-name { font-weight: bold; color: #2c3e50; }
        .ability-score { font-size: 1.5em; color: #3498db; font-weight: bold; text-align: center; }
        .skills { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .skill-item { padding: 5px; border-left: 3px solid #3498db; padding-left: 10px; }
        .text-section { margin-top: 10px; }
        .text-section textarea { width: 100%; border: 1px solid #bdc3c7; padding: 8px; font-family: inherit; }
        @media print {
            body { margin: 10px; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <h1>${characterData.character_name}</h1>
    <div class="subtitle">${characterData.player_name} - ${characterData.race} ${characterData.class_name}</div>
    
    <div class="header-info">
        <div class="header-item">
            <div class="header-label">Race:</div>
            <div>${characterData.race}</div>
        </div>
        <div class="header-item">
            <div class="header-label">Class:</div>
            <div>${characterData.class_name}</div>
        </div>
        <div class="header-item">
            <div class="header-label">Background:</div>
            <div>${characterData.background}</div>
        </div>
        <div class="header-item">
            <div class="header-label">Alignment:</div>
            <div>${characterData.alignment}</div>
        </div>
        <div class="header-item">
            <div class="header-label">Level:</div>
            <div>${characterData.level}</div>
        </div>
        <div class="header-item">
            <div class="header-label">Player:</div>
            <div>${characterData.player_name}</div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Ability Scores</div>
        <div class="ability-row">
            <div class="ability-box">
                <div class="ability-name">Strength</div>
                <div class="ability-score">${characterData.ability_scores.strength}</div>
            </div>
            <div class="ability-box">
                <div class="ability-name">Dexterity</div>
                <div class="ability-score">${characterData.ability_scores.dexterity}</div>
            </div>
            <div class="ability-box">
                <div class="ability-name">Constitution</div>
                <div class="ability-score">${characterData.ability_scores.constitution}</div>
            </div>
            <div class="ability-box">
                <div class="ability-name">Intelligence</div>
                <div class="ability-score">${characterData.ability_scores.intelligence}</div>
            </div>
            <div class="ability-box">
                <div class="ability-name">Wisdom</div>
                <div class="ability-score">${characterData.ability_scores.wisdom}</div>
            </div>
            <div class="ability-box">
                <div class="ability-name">Charisma</div>
                <div class="ability-score">${characterData.ability_scores.charisma}</div>
            </div>
        </div>
    </div>

    ${characterData.skills.length > 0 ? `
    <div class="section">
        <div class="section-title">Skills</div>
        <div class="skills">
            ${characterData.skills.map(skill => `<div class="skill-item">‚úì ${skill}</div>`).join('')}
        </div>
    </div>
    ` : ''}

    ${characterData.personality_traits ? `
    <div class="section">
        <div class="section-title">Personality Traits</div>
        <div>${characterData.personality_traits}</div>
    </div>
    ` : ''}

    ${characterData.ideals ? `
    <div class="section">
        <div class="section-title">Ideals</div>
        <div>${characterData.ideals}</div>
    </div>
    ` : ''}

    ${characterData.bonds ? `
    <div class="section">
        <div class="section-title">Bonds</div>
        <div>${characterData.bonds}</div>
    </div>
    ` : ''}

    ${characterData.flaws ? `
    <div class="section">
        <div class="section-title">Flaws</div>
        <div>${characterData.flaws}</div>
    </div>
    ` : ''}

    ${characterData.background_story ? `
    <div class="section">
        <div class="section-title">Background Story</div>
        <div>${characterData.background_story.replace(/\n/g, '<br>')}</div>
    </div>
    ` : ''}

    ${characterData.equipment_notes ? `
    <div class="section">
        <div class="section-title">Equipment & Notes</div>
        <div>${characterData.equipment_notes.replace(/\n/g, '<br>')}</div>
    </div>
    ` : ''}

    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #bdc3c7; font-size: 0.9em; color: #7f8c8d;">
        Created: ${new Date().toLocaleString()}
    </div>
</body>
</html>
                `;
                
                printWindow.document.write(printContent);
                printWindow.document.close();
                
                // Trigger print dialog after content loads
                setTimeout(() => {
                    printWindow.print();
                }, 500);
                
                alert(`‚úÖ Downloads ready!\n\n1. JSON file downloaded: character-data.json\n\n2. PDF print dialog opening...\n   Click "Save as PDF" to save the character sheet\n\nüìÅ Save both files to:\nMyCharacters/${playerName}/${charName}/`);
            }, 500);
        }

        // Clear form
        function clearForm() {
            if (confirm('Are you sure you want to clear the entire form?')) {
                document.querySelectorAll('input[type="text"], input[type="number"], textarea, select').forEach(el => {
                    if (el.type === 'number') el.value = '10';
                    else el.value = '';
                });
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                document.getElementById('raceSummary').textContent = '-';
                document.getElementById('classSummary').textContent = '-';
                document.getElementById('backgroundSummary').textContent = '-';
                document.getElementById('alignmentSummary').textContent = '-';
            }
        }

        // Save to localStorage on input
        const allInputs = document.querySelectorAll('input, textarea, select');
        allInputs.forEach(el => {
            el.addEventListener('input', () => saveFormToLocalStorage());
            el.addEventListener('change', () => {
                // When an ability score is manually changed, update used scores
                if (el.classList.contains('ability-input')) {
                    const oldValue = el.dataset.lastValue;
                    const newValue = el.value;
                    
                    // If clearing a score, make it available again
                    if (oldValue && oldValue !== '10') {
                        usedScores.delete(oldValue);
                        enableScoreButton(oldValue);
                    }
                    
                    // If setting a new score from rolled values, mark it as used
                    if (newValue && rolledScores.includes(parseInt(newValue))) {
                        usedScores.add(newValue);
                        disableScoreButton(newValue);
                    }
                    
                    el.dataset.lastValue = newValue;
                }
                saveFormToLocalStorage();
            });
        });

        function saveFormToLocalStorage() {
            const formData = {};
            document.querySelectorAll('input[type="text"], input[type="number"], textarea, select').forEach(el => {
                formData[el.id] = el.value;
            });
            document.querySelectorAll('input[type="checkbox"]').forEach(el => {
                formData[el.id] = el.checked;
            });
            localStorage.setItem('characterFormData', JSON.stringify(formData));
        }

        function loadFormFromLocalStorage() {
            const saved = localStorage.getItem('characterFormData');
            if (saved) {
                const formData = JSON.parse(saved);
                Object.entries(formData).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (el.type === 'checkbox') {
                            el.checked = value;
                        } else {
                            el.value = value;
                        }
                    }
                });
                // Trigger summary updates
                document.getElementById('race').dispatchEvent(new Event('change'));
                document.getElementById('class').dispatchEvent(new Event('change'));
                document.getElementById('background').dispatchEvent(new Event('change'));
                document.getElementById('alignment').dispatchEvent(new Event('change'));
            }
        }

        // Load on page load
        window.addEventListener('load', loadFormFromLocalStorage);
    </script>
</body>
</html>
